<view class="chat-container">
  <!-- ä¾§è¾¹æ  -->
  <view class="sidebar {{showSidebar ? 'show' : ''}}">
    <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
    <view class="sidebar-header">
      <view class="app-title">AIåŠ©æ‰‹</view>
      <view class="new-chat-btn" bindtap="createNewChat">
        <text class="icon">âœš</text>
        <text>æ–°å¯¹è¯</text>
      </view>
    </view>

    <!-- ä¼šè¯åˆ—è¡¨ -->
    <scroll-view class="conversations-list" scroll-y>
      <view 
        class="conversation-item {{currentConversationId === item.id ? 'active' : ''}}"
        wx:for="{{conversations}}"
        wx:key="id"
        bindtap="switchConversation"
        bindlongpress="showConversationMenu"
        data-id="{{item.id}}"
        data-title="{{item.title}}"
      >
        <view class="conversation-content">
          <text class="conversation-icon">ğŸ’¬</text>
          <view class="conversation-info">
            <text class="conversation-title">{{item.title}}</text>
            <text class="conversation-time">{{item.timeText}}</text>
          </view>
        </view>
        <view class="conversation-actions">
          <view 
            class="delete-btn" 
            catchtap="deleteConversation"
            data-id="{{item.id}}"
          >
            ğŸ—‘ï¸
          </view>
        </view>
      </view>

      <view wx:if="{{conversations.length === 0}}" class="empty-conversations">
        <text>æš‚æ— å¯¹è¯</text>
      </view>
    </scroll-view>
  </view>

  <!-- ä¸»èŠå¤©åŒºåŸŸ -->
  <view class="main-content">
    <!-- é¡¶éƒ¨æ  -->
    <view class="top-bar">
      <view class="menu-btn" bindtap="toggleSidebar">â˜°</view>
      <view class="current-title">{{currentTitle}}</view>
      <view class="placeholder"></view>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <scroll-view 
      class="messages-view" 
      scroll-y 
      scroll-into-view="{{scrollIntoView}}" 
      scroll-with-animation
    >
      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{messages.length === 0 && !loading}}" class="empty-messages">
        <view class="empty-icon">ğŸ’­</view>
        <view class="empty-title">å¼€å§‹æ–°å¯¹è¯</view>
        <view class="empty-desc">è¯´å‡ºä½ çš„æƒ³æ³•ï¼Œæˆ‘ä¼šå°½åŠ›å¸®åŠ©ä½ </view>
      </view>

      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <view class="message-item" wx:for="{{messages}}" wx:key="id" id="msg-{{index}}">
        <!-- AIæ¶ˆæ¯ -->
        <view wx:if="{{item.role === 'assistant'}}" class="message-wrapper assistant-message">
          <view class="avatar">ğŸ¤–</view>
          <view class="message-content">
            <!-- è”ç½‘æœç´¢æ ‡è¯† -->
            <view wx:if="{{item.meta && item.meta.webSearch}}" class="search-badge">
              <text class="badge-icon">ğŸŒ</text>
              <text class="badge-text">ä½¿ç”¨äº†{{item.meta.webSearch.source}}æœç´¢</text>
            </view>
            
            <view class="message-bubble">
              <rich-text class="message-text" nodes="{{item.formattedContent || item.content}}" user-select="{{true}}"></rich-text>
            </view>
          </view>
        </view>

        <!-- ç”¨æˆ·æ¶ˆæ¯ -->
        <view wx:else class="message-wrapper user-message">
          <view class="message-content">
            <view class="message-bubble">
              <text class="message-text" user-select="{{true}}">{{item.content}}</text>
            </view>
          </view>
          <view class="avatar user-avatar">âœŒï¸</view>
        </view>
      </view>

      <!-- åŠ è½½ä¸­æç¤º -->
      <view wx:if="{{loading}}" class="message-wrapper assistant-message">
        <view class="avatar">ğŸ¤–</view>
        <view class="message-content">
          <view class="loading-dots">
            <view class="dot"></view>
            <view class="dot"></view>
            <view class="dot"></view>
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- è¾“å…¥æ¡† -->
    <view class="input-wrapper">
      <!-- è”ç½‘æœç´¢å¼€å…³ -->
      <view class="search-toggle-bar">
        <view 
          class="search-toggle {{enableWebSearch ? 'active' : ''}}"
          bindtap="toggleWebSearch"
        >
          <text class="search-icon">ğŸŒ</text>
          <text class="search-text">è”ç½‘æœç´¢</text>
        </view>
        <text class="search-hint" wx:if="{{enableWebSearch}}">AIå°†æœç´¢äº’è”ç½‘è·å–æœ€æ–°ä¿¡æ¯</text>
      </view>

      <view class="input-container">
        <textarea 
          class="input-text" 
          placeholder="{{enableWebSearch ? 'è¾“å…¥é—®é¢˜ï¼ŒAIå°†è”ç½‘æœç´¢...' : 'è¾“å…¥æ¶ˆæ¯...'}}" 
          value="{{inputText}}"
          bindinput="onInput"
          maxlength="2000"
          auto-height
          show-confirm-bar="{{false}}"
          adjust-position="{{true}}"
        />
        <view 
          class="send-btn {{inputText ? 'active' : ''}}" 
          bindtap="sendMessage"
        >
          <text wx:if="{{!loading}}">â¬†</text>
          <text wx:else>â¸</text>
        </view>
      </view>
    </view>
  </view>

  <!-- é®ç½©å±‚ -->
  <view 
    class="sidebar-mask {{showSidebar ? 'show' : ''}}" 
    bindtap="toggleSidebar"
  ></view>
</view>


