# å¾®ä¿¡äº‘æ‰˜ç®¡æ ‡å‡†éƒ¨ç½²æŒ‡å—

æ ¹æ®[å¾®ä¿¡äº‘æ‰˜ç®¡å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/wxcloudservice/wxcloudrun/src/guide/service/online.html)è¿›è¡Œæ ‡å‡†åŒ–æ”¹é€ ã€‚

## ðŸ“‹ äº‘æ‰˜ç®¡éƒ¨ç½²æµç¨‹

æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œäº‘æ‰˜ç®¡çš„å®Œæ•´å‘å¸ƒæµç¨‹åŒ…æ‹¬ï¼š

1. **é€‰æ‹©ä»£ç ** - é€‰æ‹©è¦å‘å¸ƒçš„ç‰ˆæœ¬
2. **éƒ¨ç½²å‘å¸ƒ** - æž„å»ºé•œåƒå¹¶éƒ¨ç½²
3. **æµ‹è¯•**ï¼ˆå¯é€‰ï¼‰- OpenIDç™½åå•æˆ–URLå‚æ•°æµ‹è¯•
4. **ç°åº¦ä¸Šçº¿** - è°ƒæ•´æµé‡æ¯”ä¾‹
5. **ç»“å•** - å®Œæˆå‘å¸ƒ

## ðŸ”§ æ ‡å‡†åŒ–æ”¹é€ æ¸…å•

### 1. å¥åº·æ£€æŸ¥æŽ¥å£ï¼ˆå¿…éœ€ï¼‰

äº‘æ‰˜ç®¡ä¼šé€šè¿‡å¥åº·æ£€æŸ¥æŽ¥å£åˆ¤æ–­æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨ã€‚

**å·²å®Œæˆ** âœ… - æˆ‘ä»¬çš„é¡¹ç›®å·²ç»åŒ…å«ï¼š

```javascript
app.get('/health', (req, res) => {
  res.json({ status: 'ok', message: 'AI Companion API is running' });
});
```

### 2. ç«¯å£é…ç½®ï¼ˆå¿…éœ€ï¼‰

äº‘æ‰˜ç®¡è¦æ±‚æœåŠ¡ç›‘å¬ **80ç«¯å£** å’Œ **0.0.0.0** åœ°å€ã€‚

**å·²å®Œæˆ** âœ… - å·²é€‚é…ï¼š

```javascript
const PORT = process.env.PORT || 80;
app.listen(PORT, '0.0.0.0', () => {
  console.log(`æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£: ${PORT}`);
});
```

### 3. Dockerfileä¼˜åŒ–

æ ¹æ®äº‘æ‰˜ç®¡æœ€ä½³å®žè·µä¼˜åŒ–ï¼š

```dockerfile
FROM node:16-alpine

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./

# å®‰è£…ç”Ÿäº§ä¾èµ–
RUN npm install --production --registry=https://registry.npmmirror.com

# å¤åˆ¶æºä»£ç 
COPY src ./src

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:80/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

# æš´éœ²ç«¯å£
EXPOSE 80

# è®¾ç½®çŽ¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=80

# å¯åŠ¨å‘½ä»¤
CMD ["node", "src/index.js"]
```

### 4. çŽ¯å¢ƒå˜é‡é…ç½®

åœ¨äº‘æ‰˜ç®¡æŽ§åˆ¶å°é…ç½®ï¼ˆä¸è¦å†™åœ¨ä»£ç é‡Œï¼‰ï¼š

```bash
# å¿…éœ€é…ç½®
NODE_ENV=production
PORT=80

# å¾®ä¿¡é…ç½®
WECHAT_APPID=ä½ çš„å°ç¨‹åºAppID
WECHAT_SECRET=ä½ çš„å°ç¨‹åºSecret

# æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨äº‘å¼€å‘MongoDBï¼‰
MONGODB_URI=mongodb://ç”¨æˆ·å:å¯†ç @mongo.{env-id}.internal:27017/ai-companion

# DeepSeeké…ç½®
DEEPSEEK_API_KEY=ä½ çš„API_Key
DEEPSEEK_API_URL=https://api.deepseek.com/v1

# JWTé…ç½®
JWT_SECRET=ä½ çš„éšæœºå¯†é’¥
```

### 5. ç‰ˆæœ¬å‘å¸ƒç­–ç•¥

æ ¹æ®å®˜æ–¹æ–‡æ¡£çš„å»ºè®®ï¼š

#### é¦–æ¬¡å‘å¸ƒ
1. é€‰æ‹©ä»£ç  â†’ éƒ¨ç½²å‘å¸ƒ â†’ ç›´æŽ¥ä¸Šçº¿ï¼ˆæµé‡100%ï¼‰

#### åŽç»­æ›´æ–°
1. é€‰æ‹©ä»£ç  â†’ éƒ¨ç½²å‘å¸ƒ
2. **å‹¾é€‰"ç°åº¦å‘å¸ƒ"**
3. è®¾ç½®æµ‹è¯•é…ç½®ï¼ˆOpenIDç™½åå•ï¼‰
4. æµ‹è¯•é€šè¿‡åŽï¼Œé€æ­¥è°ƒæ•´æµé‡ï¼š10% â†’ 30% â†’ 50% â†’ 100%
5. è§‚å¯Ÿç›‘æŽ§æŒ‡æ ‡ï¼Œç¡®è®¤æ— é—®é¢˜åŽç»“å•

### 6. ç›‘æŽ§å’Œæ—¥å¿—

äº‘æ‰˜ç®¡æä¾›çš„ç›‘æŽ§åŠŸèƒ½ï¼š
- CPUä½¿ç”¨çŽ‡
- å†…å­˜ä½¿ç”¨çŽ‡
- è¯·æ±‚æ•°/QPS
- å“åº”æ—¶é—´
- é”™è¯¯çŽ‡

æŸ¥çœ‹æ—¥å¿—æ–¹å¼ï¼š
```bash
# ä½¿ç”¨CLIæŸ¥çœ‹å®žæ—¶æ—¥å¿—
cloudbase run logs -s ai-companion-api -f

# æˆ–åœ¨æŽ§åˆ¶å° â†’ æœåŠ¡æ—¥å¿— æŸ¥çœ‹
```

## ðŸ“ å®Œæ•´éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šå‡†å¤‡æ•°æ®åº“

ä½¿ç”¨äº‘å¼€å‘MongoDBï¼ˆæŽ¨èï¼‰ï¼š

1. è¿›å…¥[äº‘å¼€å‘æŽ§åˆ¶å°](https://console.cloud.tencent.com/tcb)
2. å¼€é€šæ•°æ®åº“æœåŠ¡
3. åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
4. è®°å½•è¿žæŽ¥ä¿¡æ¯ï¼š
   ```
   å†…ç½‘åœ°å€ï¼šmongo.{env-id}.internal
   ç«¯å£ï¼š27017
   ç”¨æˆ·åï¼štcb_{env-id}
   ```

### æ­¥éª¤2ï¼šé…ç½®çŽ¯å¢ƒå˜é‡

åœ¨äº‘æ‰˜ç®¡æŽ§åˆ¶å°é…ç½®æ‰€æœ‰å¿…éœ€çš„çŽ¯å¢ƒå˜é‡ï¼ˆè§ä¸Šæ–‡ï¼‰ã€‚

### æ­¥éª¤3ï¼šé¦–æ¬¡å‘å¸ƒ

1. è¿›å…¥äº‘æ‰˜ç®¡æŽ§åˆ¶å°
2. é€‰æ‹©æœåŠ¡"ai-companion-api"
3. ç‚¹å‡»"å‘å¸ƒ"
4. **é€‰æ‹©ä»£ç **ï¼š
   - ä»£ç æ¥æºï¼šæœ¬åœ°ä»£ç åŒ…/é•œåƒä»“åº“
   - å¦‚æžœæ˜¯æœ¬åœ°ï¼šä¸Šä¼ ä»£ç åŒ…
5. **éƒ¨ç½²å‘å¸ƒ**ï¼š
   - æœåŠ¡é…ç½®ï¼š0.5æ ¸/1GBï¼ˆå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰
   - å‰¯æœ¬æ•°ï¼š1-5ï¼ˆè‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰
   - æ‰©ç¼©å®¹æ¡ä»¶ï¼šCPU > 60% æˆ– å†…å­˜ > 60%
6. ç­‰å¾…æž„å»ºå®Œæˆï¼ˆçº¦5-10åˆ†é’Ÿï¼‰
7. éƒ¨ç½²æˆåŠŸåŽï¼Œæµé‡è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬

### æ­¥éª¤4ï¼šéªŒè¯éƒ¨ç½²

```bash
# 1. æµ‹è¯•å¥åº·æ£€æŸ¥
curl https://ä½ çš„æœåŠ¡åœ°å€/health

# 2. æµ‹è¯•ç™»å½•æŽ¥å£
curl -X POST https://ä½ çš„æœåŠ¡åœ°å€/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"code":"test"}'

# 3. æŸ¥çœ‹æ—¥å¿—
cloudbase run logs -s ai-companion-api -n 50
```

### æ­¥éª¤5ï¼šé…ç½®å°ç¨‹åº

ä¿®æ”¹å°ç¨‹åº `app.js`ï¼š

```javascript
globalData: {
  // ä½¿ç”¨äº‘æ‰˜ç®¡æœåŠ¡åœ°å€
  apiBaseUrl: 'https://ai-companion-api-{éšæœºID}.{env-id}.service.tcloudbase.com/api'
}
```

åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æœåŠ¡å™¨åŸŸåã€‚

### æ­¥éª¤6ï¼šåŽç»­æ›´æ–°ï¼ˆç°åº¦å‘å¸ƒï¼‰

1. ä¿®æ”¹ä»£ç åŽï¼Œç‚¹å‡»"å‘å¸ƒ"
2. **å‹¾é€‰"ç°åº¦å‘å¸ƒ"**
3. é…ç½®æµ‹è¯•ï¼š
   - OpenIDç™½åå•ï¼šæ·»åŠ æµ‹è¯•äººå‘˜çš„OpenID
   - æˆ–URLå‚æ•°ï¼šè®¾ç½®æµ‹è¯•æ ‡è¯†
4. æ›´æ–°æµ‹è¯•é…ç½®ï¼Œæµ‹è¯•äººå‘˜è¿›è¡Œæµ‹è¯•
5. æµ‹è¯•é€šè¿‡åŽï¼Œ**è°ƒæ•´æµé‡æ¯”ä¾‹**ï¼š
   - 10% â†’ è§‚å¯Ÿ10åˆ†é’Ÿ
   - 30% â†’ è§‚å¯Ÿ10åˆ†é’Ÿ
   - 50% â†’ è§‚å¯Ÿ10åˆ†é’Ÿ
   - 100% â†’ å®Œå…¨ä¸Šçº¿
6. ç‚¹å‡»"ç»“å•"å®Œæˆå‘å¸ƒ

### æ­¥éª¤7ï¼šå›žé€€ï¼ˆå¦‚é‡é—®é¢˜ï¼‰

å¦‚æžœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼š

1. åœ¨å‘å¸ƒæµç¨‹ä¸­ç‚¹å‡»"å›žé€€"
2. æˆ–åœ¨åŽ†å²ç‰ˆæœ¬ä¸­é€‰æ‹©ç¨³å®šç‰ˆæœ¬
3. ç‚¹å‡»"å›žé€€"ï¼Œæµé‡ç«‹å³åˆ‡å›žæ—§ç‰ˆæœ¬
4. æ—§ç‰ˆæœ¬çš„å®žä¾‹ä¼šä¿æŒåˆ›å»ºæ—¶çš„é…ç½®

## ðŸš¨ å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1ï¼šæ•°æ®åº“è¿žæŽ¥å¤±è´¥

**é”™è¯¯**ï¼š`Unknown database 'xxx'`

**è§£å†³**ï¼š
1. ç¡®è®¤æ•°æ®åº“å·²åˆ›å»º
2. æ£€æŸ¥ MONGODB_URI çŽ¯å¢ƒå˜é‡æ ¼å¼ï¼š
   ```
   mongodb://ç”¨æˆ·å:å¯†ç @å†…ç½‘åœ°å€:27017/æ•°æ®åº“å
   ```
3. ä½¿ç”¨å†…ç½‘åœ°å€ï¼ˆ*.internalï¼‰

### é—®é¢˜2ï¼šæœåŠ¡æ— æ³•å¯åŠ¨

**é”™è¯¯**ï¼š`Readiness probe failed`

**è§£å†³**ï¼š
1. ç¡®è®¤æœåŠ¡ç›‘å¬ 80 ç«¯å£
2. ç¡®è®¤å¥åº·æ£€æŸ¥æŽ¥å£ `/health` å¯è®¿é—®
3. æŸ¥çœ‹æœåŠ¡æ—¥å¿—æŽ’æŸ¥å¯åŠ¨é”™è¯¯

### é—®é¢˜3ï¼šçŽ¯å¢ƒå˜é‡ä¸ç”Ÿæ•ˆ

**è§£å†³**ï¼š
1. çŽ¯å¢ƒå˜é‡åœ¨"ç‰ˆæœ¬åˆ›å»ºæ—¶"é”å®š
2. ä¿®æ”¹çŽ¯å¢ƒå˜é‡åŽéœ€è¦é‡æ–°å‘å¸ƒç‰ˆæœ¬
3. ä¸èƒ½ç›´æŽ¥ä¿®æ”¹çŽ°æœ‰ç‰ˆæœ¬çš„çŽ¯å¢ƒå˜é‡

### é—®é¢˜4ï¼šæ—§ç‰ˆæœ¬è¿˜åœ¨è¿è¡Œ

**æ­£å¸¸çŽ°è±¡**ï¼š
- æ–°ç‰ˆæœ¬å‘å¸ƒåŽï¼Œæ—§ç‰ˆæœ¬ä¼šç¼“å­˜2åˆ†é’Ÿ
- è¿™æ˜¯ä¸ºäº†å¹³æ»‘è¿‡æ¸¡å’Œå¿«é€Ÿå›žæ»š
- 2åˆ†é’ŸåŽè‡ªåŠ¨ç¼©å®¹åˆ°0

## ðŸ“Š ç‰ˆæœ¬ç®¡ç†æœ€ä½³å®žè·µ

### ç‰ˆæœ¬å‘½åè§„èŒƒ

å»ºè®®ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼š
- v1.0.0 - é¦–æ¬¡å‘å¸ƒ
- v1.1.0 - æ·»åŠ æ–°åŠŸèƒ½
- v1.1.1 - Bugä¿®å¤
- v2.0.0 - é‡å¤§æ›´æ–°

### ç°åº¦ç­–ç•¥

æ ¹æ®ä¸šåŠ¡é‡è¦æ€§é€‰æ‹©ï¼š

**ä½Žé£Žé™©æ›´æ–°**ï¼ˆUIè°ƒæ•´ã€æ–‡æ¡ˆä¿®æ”¹ï¼‰ï¼š
- ç›´æŽ¥100%ä¸Šçº¿

**ä¸­é£Žé™©æ›´æ–°**ï¼ˆæ–°åŠŸèƒ½ï¼‰ï¼š
- 10% â†’ 50% â†’ 100%

**é«˜é£Žé™©æ›´æ–°**ï¼ˆæ ¸å¿ƒé€»è¾‘ä¿®æ”¹ï¼‰ï¼š
- 5% â†’ 10% â†’ 30% â†’ 50% â†’ 80% â†’ 100%
- æ¯ä¸ªé˜¶æ®µè§‚å¯Ÿ15-30åˆ†é’Ÿ

### å›žé€€ç­–ç•¥

**ç«‹å³å›žé€€**æƒ…å†µï¼š
- æœåŠ¡å®Œå…¨ä¸å¯ç”¨
- é”™è¯¯çŽ‡ > 5%
- æ ¸å¿ƒåŠŸèƒ½å¤±æ•ˆ

**ç»§ç»­è§‚å¯Ÿ**æƒ…å†µï¼š
- é”™è¯¯çŽ‡ < 1%
- æ€§èƒ½è½»å¾®ä¸‹é™
- éžæ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸

## ðŸŽ¯ äº‘æ‰˜ç®¡ vs ä¼ ç»Ÿéƒ¨ç½²

| ç‰¹æ€§ | äº‘æ‰˜ç®¡ | ä¼ ç»ŸæœåŠ¡å™¨ |
|-----|-------|-----------|
| ç°åº¦å‘å¸ƒ | âœ… å†…ç½®æ”¯æŒ | âŒ éœ€è‡ªå·±å®žçŽ° |
| ç‰ˆæœ¬å›žé€€ | âœ… ä¸€é”®å›žé€€ | âš ï¸ æ‰‹åŠ¨æ“ä½œ |
| æµé‡åˆ‡æ¢ | âœ… è‡ªåŠ¨åˆ‡æ¢ | âŒ éœ€é…ç½®è´Ÿè½½å‡è¡¡ |
| ç›‘æŽ§å‘Šè­¦ | âœ… å†…ç½® | âŒ éœ€è‡ªå»º |
| é›¶åœæœºéƒ¨ç½² | âœ… è‡ªåŠ¨ | âš ï¸ éœ€é…ç½® |

## ðŸ“ž èŽ·å–å¸®åŠ©

- [äº‘æ‰˜ç®¡æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/wxcloudservice/wxcloudrun/src/guide/service/online.html)
- [äº‘æ‰˜ç®¡æŽ§åˆ¶å°](https://console.cloud.tencent.com/tcb/service)
- æŸ¥çœ‹æœåŠ¡æ—¥å¿—æŽ’æŸ¥é—®é¢˜
- ä½¿ç”¨WebShellç™»å½•å®žä¾‹è°ƒè¯•

---

**æ ¹æ®å®˜æ–¹æ–‡æ¡£æ”¹é€ å®Œæˆ** âœ…

çŽ°åœ¨é¡¹ç›®å®Œå…¨ç¬¦åˆå¾®ä¿¡äº‘æ‰˜ç®¡çš„æ ‡å‡†è§„èŒƒï¼

