# 联网搜索功能测试指南

## 🚨 问题诊断

如果联网搜索没有生效（返回旧信息），请按以下步骤排查：

---

## ✅ 步骤1：确认已开启联网搜索

在小程序聊天界面：

1. 查看输入框**上方**是否有 **"🌐 联网搜索"** 按钮
2. **点击**该按钮，确保它变成**绿色**
3. 看到提示"已开启联网搜索"
4. 此时输入框提示文字会变为："输入问题，AI将联网搜索..."

**关键**：只有开启后发送的消息才会联网！

---

## ✅ 步骤2：查看服务器日志

重启服务器后，发送消息时应该看到：

```bash
=== 联网搜索调试信息 ===
enableWebSearch: true
用户问题: 特朗普最新的5条新闻
是否需要搜索: true
✅ 开始执行联网搜索...
开始搜索: 特朗普最新的5条新闻
使用 DuckDuckGo 找到 3 个结果
✅ 搜索成功! 来源: DuckDuckGo, 结果数: 3
=== 搜索调试结束 ===
```

**如果看不到这些日志**，说明联网搜索功能没有被调用。

---

## ✅ 步骤3：配置搜索API（推荐）

### 当前默认使用DuckDuckGo（免费但结果有限）

为了获得更好的搜索结果，建议配置以下任一API：

### 方案A：SerpAPI (推荐 - Google搜索)

1. 访问 https://serpapi.com/
2. 注册账号（GitHub/Google登录）
3. 获取API Key（免费100次/月）
4. 在服务器上配置环境变量：

```bash
export SERPAPI_KEY=your_serpapi_key_here
```

或在云托管控制台添加环境变量 `SERPAPI_KEY`

### 方案B：Bing Search API

1. 访问 Azure Portal: https://portal.azure.com/
2. 创建"Bing Search v7"资源
3. 获取API Key（免费1000次/月）
4. 配置环境变量：

```bash
export BING_SEARCH_KEY=your_bing_key_here
```

---

## ✅ 步骤4：重启服务器

配置API后，**必须重启服务器**：

```bash
# 本地
npm start

# 或云托管
# 在控制台重启服务
```

---

## 🧪 测试用例

### 测试1：带时间关键词的问题（自动触发搜索）

```
问题: 今天北京的天气怎么样？
问题: 2025年最新的AI技术有哪些？
问题: 特朗普最新的新闻
```

这些问题即使**不开启**联网搜索开关，也会自动搜索。

### 测试2：手动开启搜索

```
1. 点击开启 🌐 联网搜索
2. 问任何问题，都会联网搜索
3. 例如: "Python的历史"
```

### 测试3：查看搜索标识

AI回复时应该显示：

```
🌐 使用了Google搜索

根据最新搜索结果...

参考来源：
1. xxx.com
2. yyy.com
```

---

## 🔍 常见问题

### Q1: 为什么AI还是返回旧信息？

**A:** 可能原因：
1. ❌ 没有点击开启联网搜索按钮（最常见）
2. ❌ 搜索API没有配置，DuckDuckGo返回结果有限
3. ❌ 问题关键词不明确

**解决：**
- 确保联网搜索按钮是**绿色**的
- 配置SerpAPI或Bing API
- 使用更具体的关键词

### Q2: 如何确认搜索功能在工作？

**A:** 看两个地方：
1. **AI回复上方有绿色徽章**："🌐 使用了XXX搜索"
2. **服务器日志有搜索记录**

如果都没有，说明搜索没被调用。

### Q3: DuckDuckGo搜索结果不准确？

**A:** DuckDuckGo是免费搜索，结果有限。建议：
- 配置SerpAPI（Google搜索，最准确）
- 或配置Bing Search（也很不错）

### Q4: 搜索速度慢？

**A:** 
- DuckDuckGo：5-10秒
- SerpAPI/Bing：2-5秒

如果超过10秒无响应，检查网络连接。

---

## 📊 搜索引擎对比

| 搜索引擎 | 准确度 | 速度 | 免费额度 | 配置难度 |
|---------|--------|------|---------|----------|
| Google (SerpAPI) | ⭐⭐⭐⭐⭐ | ⚡⚡⚡⚡ | 100次/月 | 简单 |
| Bing Search | ⭐⭐⭐⭐ | ⚡⚡⚡⚡ | 1000次/月 | 中等 |
| DuckDuckGo | ⭐⭐⭐ | ⚡⚡⚡ | 无限制 | 无需配置 |
| 模拟搜索 | ⭐ | ⚡⚡⚡⚡⚡ | 无限制 | 无需配置 |

---

## 🎯 完整测试流程

1. **开启联网搜索** - 点击绿色按钮 ✅
2. **发送问题** - "特朗普2025年最新新闻"
3. **查看服务器日志** - 应该看到搜索日志
4. **检查AI回复** - 应该有 🌐 徽章
5. **验证信息时效** - 回答应该包含最新日期

如果以上任一步骤失败，说明有问题。

---

## 💡 提示

1. **第一次使用**：建议先用DuckDuckGo测试（无需配置）
2. **正式使用**：配置SerpAPI获得最佳体验
3. **调试时**：观察服务器日志很重要
4. **问题描述**：越具体越好，如"2025年1月特朗普新闻"

---

## 📞 仍然有问题？

检查清单：
- [ ] 已重启服务器
- [ ] 联网搜索按钮是绿色的
- [ ] 服务器日志有搜索记录
- [ ] 已配置至少一个搜索API
- [ ] 网络连接正常

如果全部确认仍有问题，请提供：
1. 服务器完整日志
2. 小程序界面截图
3. 具体的测试问题

祝测试顺利！🚀

